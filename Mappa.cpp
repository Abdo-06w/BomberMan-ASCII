#include "Mappa.h"
#include "Game.h"

Maps::~Maps() {
    delete livello;
}

int lvl1[20][40] = {
    {2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2},
    {3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2},
    {2,0,1,1,2,1,1,2,1,1,1,1,0,0,1,1,2,1,1,1,2,1,1,1,1,2,1,1,0,0,1,1,2,1,1,2,1,1,0,2},
    {2,0,1,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,1,0,2},
    {2,0,2,0,0,2,0,0,0,2,0,1,0,0,2,0,0,2,0,0,0,0,0,2,0,0,0,1,0,0,2,0,0,2,0,0,0,1,0,2},
    {2,0,1,0,0,1,1,2,1,0,0,1,0,0,1,0,0,1,1,2,1,1,2,1,0,0,0,1,0,0,1,0,0,1,1,0,0,2,2,2},
    {2,0,2,0,0,1,0,0,0,0,0,2,0,0,2,0,0,0,0,0,0,0,0,1,0,0,0,2,0,0,2,0,0,1,0,0,0,2,0,2},
    {2,0,1,0,0,2,0,0,2,0,0,0,0,0,0,0,0,0,2,0,0,0,0,2,0,0,0,0,0,0,0,0,0,2,0,0,0,1,0,2},
    {2,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,2,0,0,0,0,0,2,0,0,0,1,0,2,0,1,0,2},
    {2,0,0,0,0,1,2,1,1,1,2,1,1,2,0,0,1,2,1,1,0,0,0,1,1,2,1,1,2,1,1,0,0,2,0,0,0,0,0,2},
    {2,0,0,2,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,2,0,0,2},
    {2,0,0,2,0,0,0,2,0,0,0,0,0,1,0,0,2,0,0,0,0,2,0,0,0,2,0,0,0,0,1,0,0,1,1,1,2,1,0,2},
    {2,0,1,1,2,1,1,2,1,1,0,0,0,2,0,0,1,0,0,1,2,1,1,1,1,2,1,0,0,0,2,0,0,0,0,0,0,0,0,2},
    {2,0,1,0,0,0,0,0,0,1,0,0,0,2,0,0,1,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,0,2},
    {2,0,2,0,0,2,0,0,0,2,0,0,0,0,0,0,0,0,0,2,0,0,2,0,0,0,2,0,0,0,0,0,0,0,0,0,2,0,0,2},
    {2,0,1,0,0,0,0,0,0,1,0,0,0,0,0,2,0,0,0,2,0,0,0,0,0,0,1,0,0,0,0,0,2,0,0,0,2,0,0,2},
    {2,0,1,2,1,1,0,0,1,1,1,2,1,1,2,1,0,0,0,1,1,2,1,0,0,0,1,1,2,2,1,1,1,1,0,0,2,0,0,2},
    {2,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,2},
    {2,0,1,0,1,0,0,1,1,1,1,0,1,1,0,0,0,2,2,0,0,1,1,2,0,0,0,0,0,2,2,1,0,1,1,1,1,0,0,4},
    {2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2}
};

int lvl2[20][40] = {
    {2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2},
    {3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2},
    {2,0,0,1,1,1,2,1,1,1,1,2,1,1,1,0,0,0,1,1,2,1,1,1,1,1,2,1,1,1,0,0,0,1,1,1,0,1,2,2},
    {2,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,2},
    {2,0,0,2,0,0,2,0,0,0,2,0,0,0,1,0,0,0,2,0,0,2,0,0,0,2,0,0,0,1,0,0,0,2,0,0,0,1,0,2},
    {2,0,0,1,0,0,1,1,2,1,1,1,0,0,1,2,1,1,1,0,0,1,1,2,1,1,0,0,0,1,2,1,1,1,0,0,0,2,0,2},
    {2,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,2},
    {2,2,2,1,0,0,0,2,0,0,0,1,0,0,0,0,2,0,0,0,0,0,2,0,0,2,0,0,0,0,0,2,0,0,0,0,0,1,0,2},
    {2,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,2,0,1,0,2},
    {2,0,0,1,1,2,1,1,0,0,0,1,1,1,2,1,1,1,0,0,1,1,2,1,1,1,0,0,1,1,2,1,1,1,1,1,0,0,0,2},
    {2,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,2},
    {2,0,2,0,0,0,0,1,0,2,0,0,0,2,0,0,0,2,0,0,1,0,0,2,0,0,0,0,2,0,0,2,0,0,0,1,2,2,1,2},
    {2,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,0,0,0,2,0,1,0,0,0,0,0,0,2,2,0,0,2},
    {2,0,1,1,2,1,1,1,1,1,2,1,1,0,0,0,0,1,0,0,1,1,1,2,1,1,1,1,1,0,0,0,1,1,2,1,1,1,0,2},
    {2,0,1,0,0,0,0,0,0,0,0,0,1,0,0,2,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,2},
    {2,0,2,0,0,2,0,0,0,2,0,0,1,0,0,0,0,0,0,0,0,2,0,0,0,2,0,0,0,0,2,0,1,0,0,2,0,2,0,2},
    {2,0,1,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,1,0,2},
    {2,0,1,1,2,1,1,2,1,1,0,0,1,1,2,1,1,0,0,1,1,2,1,1,2,1,0,0,1,1,2,1,1,1,2,1,1,1,0,2},
    {2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4},
    {2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2}
};

int lvl3[20][40] = {
    {2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2},
    {3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2},
    {2,0,1,2,1,1,1,0,0,1,1,2,1,1,1,2,1,0,0,1,1,1,2,1,1,0,0,1,2,1,1,1,0,0,1,1,2,1,0,2},
    {2,0,1,0,0,0,1,0,0,1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,2},
    {2,0,2,0,0,0,1,2,2,1,0,0,2,0,0,0,2,0,0,2,0,0,2,0,1,2,2,1,0,0,0,2,0,0,1,0,0,2,2,2},
    {2,0,1,0,0,0,0,0,0,0,0,0,1,1,2,1,1,0,0,1,0,0,1,0,0,0,0,0,0,0,0,1,2,1,1,0,0,1,2,2},
    {2,0,1,2,1,1,0,0,0,0,2,0,0,0,0,0,0,0,0,1,2,1,1,0,0,0,2,0,0,0,0,0,0,0,0,0,0,1,2,2},
    {2,0,0,0,0,1,0,0,2,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,2,0,0,0,0,2,2},
    {2,2,0,0,0,1,2,1,1,1,0,0,1,2,1,1,1,2,1,1,0,0,1,1,2,1,1,1,1,0,0,1,2,1,1,1,0,0,2,2},
    {2,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,1,0,0,0,2},
    {2,2,2,0,0,0,0,0,0,2,0,0,2,0,0,2,0,0,0,1,0,0,2,0,0,2,0,0,2,0,0,2,0,0,0,1,0,2,0,2},
    {2,0,1,1,2,1,0,0,0,1,0,0,1,0,0,1,2,1,1,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,2,0,0,0,2},
    {2,0,0,0,0,1,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,1,1,0,0,0,0,0,0,1,0,0,0,2},
    {2,0,0,0,0,2,0,0,0,0,0,2,0,0,0,0,0,2,0,0,0,2,0,0,0,0,0,0,0,0,2,0,0,0,0,1,0,2,0,2},
    {2,0,1,2,1,1,1,0,0,1,1,2,1,1,0,0,1,1,2,1,1,1,0,0,1,1,2,1,0,0,1,1,2,1,1,1,0,0,0,2},
    {2,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,0,0,0,0,2},
    {2,0,2,0,0,0,2,0,0,2,0,0,0,2,0,0,2,0,0,0,0,2,0,0,2,0,0,2,0,0,2,0,0,0,0,0,2,0,0,2},
    {2,0,1,1,0,0,1,1,2,1,0,0,1,1,2,1,1,0,0,1,1,1,2,1,1,0,0,1,2,1,1,0,0,1,1,2,1,0,0,2},
    {2,0,1,1,0,0,0,0,2,0,0,0,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4},
    {2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2}
};

int lvl4[20][40] = {
    {2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2},
    {3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2},
    {2,0,1,1,2,1,0,1,2,1,1,0,1,1,2,0,1,2,1,1,0,1,1,2,1,0,1,2,1,1,0,1,1,2,1,1,1,1,0,2},
    {2,0,1,0,0,1,0,1,0,0,1,0,1,0,0,0,1,0,0,1,0,1,0,0,1,0,1,0,0,1,0,1,0,0,1,0,0,1,0,2},
    {2,2,1,0,0,2,0,2,0,0,1,2,1,0,0,2,1,0,0,2,0,2,0,0,1,2,1,0,0,2,0,2,0,0,1,2,0,1,2,2},
    {2,0,0,0,0,1,0,1,0,0,0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,2},
    {2,0,1,2,1,1,0,1,2,1,1,0,1,2,1,1,0,1,2,1,0,1,2,1,1,0,1,2,1,1,0,1,2,1,1,0,2,1,0,2},
    {2,0,1,0,0,0,0,0,0,0,1,0,1,0,0,0,0,1,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,1,0,0,1,0,2},
    {2,0,2,0,0,0,2,0,0,0,2,0,2,0,0,0,2,2,0,0,0,2,0,0,2,0,2,0,0,0,2,0,0,0,2,0,0,2,0,2},
    {2,0,1,1,2,1,1,0,1,2,1,0,1,1,2,1,1,0,0,1,2,1,1,0,1,0,1,1,2,1,1,0,1,2,1,0,0,1,0,2},
    {2,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,2},
    {2,2,0,0,2,0,2,0,2,0,0,2,0,0,2,0,2,0,0,2,0,0,2,0,0,2,0,0,2,0,2,0,2,0,0,2,2,0,2,2},
    {2,0,1,2,1,0,1,0,1,1,2,1,0,1,1,0,1,2,1,1,0,1,1,2,1,1,0,1,1,0,1,0,1,1,2,1,0,1,0,2},
    {2,0,1,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,1,0,1,0,2},
    {2,0,2,0,0,2,0,0,2,0,0,2,0,2,0,0,2,0,0,2,0,0,2,0,0,2,0,2,0,0,2,0,0,2,2,2,0,2,0,2},
    {2,0,1,0,0,1,2,1,1,0,0,1,0,1,0,0,1,2,1,1,0,0,1,2,1,1,0,1,0,0,1,2,1,1,0,1,0,1,0,2},
    {2,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,2},
    {2,1,1,2,1,1,0,0,2,1,2,1,1,0,1,2,1,0,0,2,1,2,1,1,0,1,2,1,0,0,1,2,1,2,1,1,0,0,0,2},
    {2,1,0,1,1,0,2,0,1,0,2,0,0,0,1,0,1,0,1,2,0,0,1,0,1,0,0,1,0,0,0,0,0,2,0,0,0,0,0,4},
    {2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2}
};

int lvl5[20][40] = {
    {2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2},
    {3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2},
    {2,0,1,2,2,2,1,1,2,1,2,2,0,1,2,1,2,2,1,2,1,2,2,0,1,2,1,2,1,1,2,1,2,1,0,1,2,1,0,2},
    {2,0,1,0,2,0,0,1,0,1,0,2,0,1,0,1,0,0,1,0,1,0,2,0,1,0,1,0,0,1,0,1,0,1,0,1,0,1,0,2},
    {2,2,1,0,2,0,0,2,0,2,0,2,2,1,0,2,0,0,2,0,2,0,1,2,1,0,2,0,0,2,0,2,0,1,2,1,0,2,2,2},
    {2,0,0,0,1,0,0,1,0,1,0,0,0,0,0,1,0,0,1,0,1,0,0,0,0,0,1,0,0,1,0,1,0,0,0,0,0,1,0,2},
    {2,0,1,2,1,0,1,2,1,1,2,1,0,1,2,1,0,1,2,1,1,2,1,0,1,2,1,0,1,2,2,2,2,1,0,1,2,1,0,2},
    {2,0,2,0,0,0,1,0,0,0,0,1,0,1,0,0,0,1,0,0,0,0,1,0,1,0,0,0,1,0,0,0,0,1,0,1,0,0,0,2},
    {2,0,2,0,0,2,2,0,0,2,0,2,0,2,0,0,2,2,0,0,2,0,2,0,2,0,0,2,2,0,0,2,0,2,0,2,0,0,2,2},
    {2,0,122,2,1,0,0,1,1,2,1,0,1,2,1,1,0,0,1,2,2,1,0,1,2,1,1,0,0,2,2,2,1,0,2,2,1,0,2},
    {2,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,1,0,2},
    {2,2,0,2,0,2,0,2,2,0,0,2,0,2,0,2,2,0,2,2,0,0,2,0,2,0,2,2,0,2,2,0,0,2,0,2,0,2,2,2},
    {2,0,1,1,2,2,0,1,0,0,1,1,2,1,0,1,0,0,1,1,2,1,2,0,1,0,1,0,0,1,1,2,1,2,0,1,2,1,0,2},
    {2,0,1,0,0,0,0,1,0,0,2,0,0,2,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,1,0,0,0,2,0,0,0,0,0,2},
    {2,0,2,0,2,0,2,2,0,2,2,0,0,2,0,2,0,2,2,0,2,0,2,0,2,0,2,0,2,2,0,2,0,2,0,2,0,2,0,2},
    {2,0,1,0,1,0,1,0,0,1,0,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,1,0,1,0,0,1,0,1,0,1,0,1,0,2},
    {2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2},
    {2,0,1,2,1,2,1,0,1,2,1,2,1,0,1,2,1,2,1,0,1,2,1,2,1,0,1,2,1,2,1,0,1,2,1,2,1,0,0,2},
    {2,0,1,2,1,2,1,0,0,0,1,1,1,0,0,0,0,1,0,2,1,1,2,1,0,0,1,1,2,1,0,0,0,0,0,0,0,0,0,4},
    {2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2}
};


Mappa::Mappa(WINDOW* win) {

    Stanza* room1 = new Stanza(win, 20, 40, lvl1);
    Stanza* room2 = new Stanza(win, 20, 40, lvl2);
    Stanza* room3 = new Stanza(win, 20, 40, lvl3);
    Stanza* room4 = new Stanza(win, 20, 40, lvl4);
    Stanza* room5 = new Stanza(win, 20, 40, lvl5);

    map1 = new Maps{room1,NULL,NULL};
    map2 = new Maps{room2,NULL,NULL};
    map3 = new Maps{room3,NULL,NULL};
    map4 = new Maps{room4,NULL,NULL};
    map5 = new Maps{room5,NULL,NULL};

    map1->next = map2;

    map2->prev = map1;
    map2->next = map3;

    map3->prev = map2;
    map3->next = map4;

    map4->prev = map3;
    map4->next = map5;

    map5->prev = map4;

    current = map1;

    points = new Points();

    map1->game = new Game(win, room1,points);
    map1->game->addEnemy({2,2});

    map2->game = new Game(win, room2,points);
    map2->game->addEnemy({2,2});
    map2->game->addEnemy({3,3});


    map3->game = new Game(win, room3,points);
    map3->game->addEnemy({2,2});
    map3->game->addEnemy({3,3});
    map3->game->addEnemy({4,2});


    map4->game = new Game(win, room4,points);
    map4->game->addEnemy({2,2});
    map4->game->addEnemy({3,3});
    map4->game->addEnemy({4,2});
    map4->game->addEnemy({5,5});


    map5->game = new Game(win, room5,points);
    map5->game->addEnemy({2,2});
    map5->game->addEnemy({3,3});
    map5->game->addEnemy({4,2});
    map5->game->addEnemy({5,5});
    map5->game->addEnemy({6,6});


    time = new Time();
    lastTick = steady_clock::now();

}

Stanza* Mappa::getCurrentRoom() {
    return current->livello;
}
Game* Mappa::getCurrentGame() {
    return current->game;
}
Points *Mappa::score() {
    return points;
}


void Mappa::nextRoom() {
    int x = current->livello->getStanzaX();
    int y = current->livello->getStanzaY();

    if (current->next == NULL) {
        current->game->getPlayer()->setPosition(y-2,x-2);
        return;
    }

    int v,d,r;

    v = current->game->getPlayer()->getStats().vita;
    d = current->game->getPlayer()->getStats().damageMultiplier;
    r = current->game->getPlayer()->getStats().rangeMultiplier;

    current = current->next;

    current->game->getPlayer()->setStats(v, d, r);
    current->game->getPlayer()->setPosition(1,1);

}

void Mappa::prevRoom() {
    if (current->prev == NULL) {
        current->game->getPlayer()->setPosition(1,1);
        return;
    }

    int v,d,r;

    v = current->game->getPlayer()->getStats().vita;
    d = current->game->getPlayer()->getStats().damageMultiplier;
    r = current->game->getPlayer()->getStats().rangeMultiplier;

    current = current->prev;

    current->game->getPlayer()->setStats(v, d, r);

    int x = current->livello->getStanzaX();
    int y = current->livello->getStanzaY();

    current->game->getPlayer()->setPosition(y-2,x-2);

}


Time* Mappa::getTimer() { return time; }

void Mappa::timer() {

    auto now = steady_clock::now();

    if (duration_cast<seconds>(now - lastTick).count() >= 1) {
        if (time->getTime() > 0) {
            time->setTime(time->getTime() - 1);
        }
        lastTick = now;
    }

}

void Mappa::delRoom() {
    Position pos = current->game->getPlayer()->getPosition();

    int v,d,r;

    v = current->game->getPlayer()->getStats().vita;
    d = current->game->getPlayer()->getStats().damageMultiplier;
    r = current->game->getPlayer()->getStats().rangeMultiplier;

    int x = current->livello->getStanzaX();
    int y = current->livello->getStanzaY();

    pMap tmp;

    if (current->livello->isPortaNext(pos.y,pos.x)) {

        if (current->prev == NULL) {
            tmp = current->next;
            delete current;
            current = tmp;
            current->prev = NULL;
        }else {
            current->prev->next = current->next;
            current->next->prev = current->prev;
            tmp = current->next;
            delete current;
            current = tmp;
        }
        time->addTime(10);
        current->game->getPoints()->addPoints(200);
        current->game->getPlayer()->setStats(v+1, d, r);
        current->game->getPlayer()->setPosition(1,1);

    }else if (current->livello->isPortaPrev(pos.y,pos.x)) {

        if (current->next == NULL) {
            tmp = current->prev;
            delete current;
            current = tmp;
            current->next = NULL;
        } else {
            current->prev->next = current->next;
            current->next->prev = current->prev;
            tmp = current->prev;
            delete current;
            current = tmp;
        }
        time->addTime(10);
        current->game->getPoints()->addPoints(200);
        current->game->getPlayer()->setStats(v+1, d, r);
        current->game->getPlayer()->setPosition(y-2,x-2);
    }

    if (current != NULL) {

        if (current->prev == NULL)
            current->livello->delPortaPrev();

        if (current->next == NULL)
            current->livello->delPortaNext();

    }

}

void Mappa::update() {


    timer();

    Position pos = current->game->getPlayer()->getPosition();

    if (current->game->getNumNemici() <= 0) {
        delRoom();
        return;
    }

    if (current->livello->isPortaNext(pos.y,pos.x)){
        nextRoom();
        return;
    }
    if (current->livello->isPortaPrev(pos.y,pos.x)) {
        prevRoom();
        return;
    }
}


bool Mappa::getHasWon() {
    return won;
}

bool Mappa::endGame() {

    if (getTimer()->getTime() <= 0 || current->game->getPlayer()->getVita() <= 0) {
        napms(700);
        won = false;
        return true;
    }

    bool noNemici = current->game->getNumNemici() <= 0;
    bool noPorta = !current->livello->isTherePortaNext() && !current->livello->isTherePortaPrev();
    if (noNemici && noPorta) {
        current->game->update();
        napms(700);
        won = true;
        return true;
    }

    return false;
}


Mappa::~Mappa() {

    delete points;
    points = NULL;

    delete time;
    time = NULL;

    while (current && current->prev != NULL)current = current->prev;

    while (current) {
        Maps* tmp = current->next;
        delete current;
        current = tmp;
    }
    current = NULL;

}
